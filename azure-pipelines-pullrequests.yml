# ASP.NET Core (.NET Framework)
# Build and test ASP.NET Core projects targeting the full .NET Framework.
# Add steps that publish symbols, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger: none

pr:
  branches:
    include:
      - '*'  # must quote since "*" is a YAML reserved character; we want a string

pool:
  vmImage: 'windows-latest'

variables:
  solution: '**/FluentMigrator.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
  - stage: Build on Windows
    jobs:
      - job: 'Build on Windows'
        pool:
          vmImage: 'windows-latest'
        steps:
          - task: NuGetToolInstaller@1

          - task: UseDotNet@2
            inputs:
              version: '7.x'

          - task: UseGitVersion@5
            displayName: 'UseGitVersion (preview)'
            inputs:
              versionSpec: '5.12'
              includePrerelease: true
              updateAssemblyInfo: false
            env:
              BUILD_BUILDNUMBER: $(GitVersion.NuGetVersionV2)

          - task: NuGetCommand@2
            inputs:
              restoreSolution: '$(solution)'

          - task: VSBuild@1
            inputs:
              solution: '$(solution)'
              platform: '$(buildPlatform)'
            configuration: '$(buildConfiguration)'
            msbuildArgs: '/p:Version="$(build.buildNumber)"'

          - task: VSTest@2
            inputs:
              platform: '$(buildPlatform)'
              configuration: '$(buildConfiguration)'
              diagnosticsEnabled: true

  - stage: Build on Ubuntu
    dependsOn: []
    jobs:
      - job: 'Build on Ubuntu'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseDotNet@2
            inputs:
              version: '7.x'

          - task: UseGitVersion@5
            displayName: 'UseGitVersion (preview)'
            inputs:
              versionSpec: '5.12'
              includePrerelease: true
              updateAssemblyInfo: false
            env:
              BUILD_BUILDNUMBER: $(GitVersion.NuGetVersionV2)

          - task: DotNetCoreCLI@2
            inputs:
              command: 'restore'

          - task: DotNetCoreCLI@1
            inputs:
              command: 'build'
              project: '$(solution)'
              configuration: '$(buildConfiguration)'
              buildProperties: 'Version="$(build.buildNumber)"'

          - task: DotNetCoreCLI@2
            inputs:
              project: '$(solution)'
              configuration: '$(buildConfiguration)'
